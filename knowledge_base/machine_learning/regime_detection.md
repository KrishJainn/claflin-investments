# Regime Detection in Financial Markets

## Overview

Financial markets alternate between distinct regimes characterized by different statistical
properties: trending vs mean-reverting, high vs low volatility, risk-on vs risk-off. Regime
detection identifies these structural shifts and allows trading systems to adapt their behavior
accordingly. This document covers the major approaches to regime detection and their application
in algorithmic trading.

---

## 1. Why Regime Detection Matters

### 1.1 The Problem with Stationary Assumptions
- Most statistical models assume data is generated by a single, stationary process
- Financial returns exhibit: time-varying volatility, shifting correlations, changing mean dynamics
- A momentum strategy that thrives in trending regimes may hemorrhage in mean-reverting regimes
- Ignoring regime changes leads to: poor risk estimates, false signals, and catastrophic drawdowns

### 1.2 Observable Regime Characteristics
- **Volatility regimes**: low-vol (VIX < 15), medium-vol (15-25), high-vol (>25)
- **Trend regimes**: bull market (positive drift), bear market (negative drift), sideways (near-zero drift)
- **Correlation regimes**: normal (moderate correlation), crisis (correlations spike to ~1)
- **Liquidity regimes**: abundant (tight spreads, deep books) vs scarce (wide spreads, thin books)
- Regimes are persistent: once entered, they tend to last weeks to months

---

## 2. Hidden Markov Models (HMMs)

### 2.1 Model Specification
- Assume returns are generated by one of K hidden states (regimes)
- State sequence: S_1, S_2, ..., S_T (unobserved)
- Transition matrix A: A_ij = P(S_{t+1} = j | S_t = i)
  - Captures regime persistence (diagonal elements) and switching probabilities (off-diagonal)
- Emission distribution: P(r_t | S_t = k) -- distribution of returns in each regime
  - Gaussian emission: r_t | S_t=k ~ N(mu_k, sigma_k^2)
  - Each regime has its own mean return and volatility

### 2.2 Parameter Estimation: Baum-Welch Algorithm
- Expectation-Maximization (EM) algorithm for HMMs
- E-step: compute forward-backward probabilities
  - alpha_t(k) = P(r_1,...,r_t, S_t=k) -- forward probability
  - beta_t(k) = P(r_{t+1},...,r_T | S_t=k) -- backward probability
  - gamma_t(k) = P(S_t=k | r_1,...,r_T) -- state posterior
- M-step: update parameters using posteriors
  - mu_k = sum(gamma_t(k) * r_t) / sum(gamma_t(k))
  - sigma_k^2 = sum(gamma_t(k) * (r_t - mu_k)^2) / sum(gamma_t(k))
  - A_ij = sum(xi_t(i,j)) / sum(gamma_t(i))
- Iterate until convergence (typically 20-100 iterations)

### 2.3 State Decoding
- **Viterbi algorithm**: find the most likely state sequence (MAP)
  - Returns a single path: S_1*, S_2*, ..., S_T*
  - Best for ex-post regime identification
- **Filtering**: P(S_t = k | r_1, ..., r_t) -- real-time regime probability
  - Uses only past and current data (no lookahead)
  - Essential for live trading applications
  - Smoothing (using future data) is only for research/backtesting

### 2.4 Practical Considerations for Financial HMMs
- **Number of states**: typically K=2 (bull/bear) or K=3 (bull/bear/sideways)
  - Use BIC or AIC for model selection: BIC = -2*logL + k*ln(n)
  - Avoid K>4: overfitting risk increases rapidly
- **Initialization sensitivity**: EM finds local optima; run multiple random initializations
- **Non-Gaussian emissions**: use Student-t for fat tails, or mixture emissions
- **Lookback window**: use 2-5 years of data for estimation; re-estimate quarterly
- **Online updating**: re-run Baum-Welch with expanding or rolling window

---

## 3. Gaussian Mixture Models (GMMs)

### 3.1 Model Specification
- Returns are drawn from a mixture of K Gaussian components:
  - P(r) = sum_{k=1}^{K} pi_k * N(r | mu_k, sigma_k^2)
  - pi_k = mixing weight (probability of being in component k)
- Unlike HMM: GMM does NOT model temporal transitions between states
- Each observation is independently assigned to a component

### 3.2 Estimation and Assignment
- Fit using EM algorithm (similar to Baum-Welch but without transition dynamics)
- Posterior assignment: P(component k | r_t) = pi_k * N(r_t | mu_k, sigma_k^2) / P(r_t)
- For multivariate features: use multivariate Gaussian with full covariance matrices
  - N(x | mu_k, Sigma_k) for each component

### 3.3 GMM vs HMM for Regime Detection
- **GMM advantages**: simpler, faster, fewer parameters, no Markov assumption
- **GMM disadvantages**: ignores regime persistence; can rapidly flip between states
- **Practical compromise**: fit GMM, then apply temporal smoothing
  - E.g., assign regime only when posterior > 0.7 for at least 5 consecutive days
- Use GMM when you care about the current state more than the transition dynamics

---

## 4. Change-Point Detection

### 4.1 Offline Methods (Retrospective)
- **CUSUM (Cumulative Sum)**: detect shifts in mean or variance
  - S_t = max(0, S_{t-1} + (r_t - mu_0) - delta)
  - Signal change when S_t > threshold h
  - Parameters: mu_0 (expected mean), delta (minimum detectable shift), h (threshold)
- **Bayesian Online Change-Point Detection (BOCPD)** (Adams & MacKay, 2007):
  - Maintains a probability distribution over the current run length
  - Run length r_t = number of observations since the last change point
  - P(r_t | data) updated sequentially using Bayesian inference
  - Produces a posterior over change-point locations
- **Binary segmentation**: recursively find single change-points in sub-segments
  - Fast but can miss closely spaced change-points
- **PELT (Pruned Exact Linear Time)**: exact segmentation with pruning
  - Optimal solution in O(n) expected time; detects multiple change-points

### 4.2 Online Methods (Real-Time)
- **BOCPD**: naturally online; update posterior with each new observation
- **Sliding window tests**: compare statistics of recent vs historical window
  - E.g., two-sample t-test on mean of last 20 days vs previous 60 days
  - Kolmogorov-Smirnov test for distributional changes
- **Adaptive thresholds**: set detection thresholds based on rolling statistics
  - Flag when metric exceeds 2-3 rolling standard deviations

### 4.3 What to Monitor for Change-Points
- Return mean: shift signals trend change
- Return variance: shift signals volatility regime change (most important)
- Correlation structure: shift signals diversification regime change
- Spread dynamics: shift in bid-ask spreads signals liquidity regime change
- Volume patterns: shift in volume signals participation regime change

---

## 5. Regime-Switching Models (Hamilton)

### 5.1 Markov-Switching Autoregressive Model (MS-AR)
- Hamilton (1989) proposed the foundational econometric regime-switching model
- r_t = mu_{S_t} + phi_{S_t} * r_{t-1} + sigma_{S_t} * epsilon_t
  - S_t follows a Markov chain with transition matrix A
  - Each regime has its own mean (mu), autoregressive coefficient (phi), and volatility (sigma)
- Maximum likelihood estimation via the Hamilton filter
- Generalization of HMM: adds autoregressive dynamics within each regime

### 5.2 Hamilton Filter
- Recursive filtering algorithm analogous to HMM forward algorithm
- For each t, compute:
  - P(S_t = k | data up to t) using likelihood of r_t under each regime
  - Update using Bayes' rule and transition probabilities
- Produces filtered regime probabilities in real time

### 5.3 Common Configurations
- **Two-state volatility switching**: mu same across states, sigma differs
  - Low-vol state: sigma_1 ~ 10-12% annualized
  - High-vol state: sigma_2 ~ 25-40% annualized
  - Transition probabilities: P(stay in low-vol) ~ 0.97, P(stay in high-vol) ~ 0.93
  - Average regime duration: 1 / (1 - P(stay)) = 33 days (low-vol), 14 days (high-vol)
- **Two-state mean switching**: mu differs, sigma may also differ
  - Bull state: mu_1 > 0 (positive drift)
  - Bear state: mu_2 < 0 (negative drift)
- **Three-state model**: bull, bear, and high-volatility-sideways

### 5.4 Extensions
- MS-GARCH: regime-switching with GARCH within each state (higher granularity)
- MS-VAR: multivariate regime switching for multiple asset returns
- Time-varying transition probabilities: P(switch) depends on external variables (e.g., VIX)

---

## 6. Clustering-Based Approaches

### 6.1 Feature-Based Regime Clustering
- Construct a feature vector for each time window (e.g., weekly):
  - [realized_vol, return, correlation, spread, volume_ratio, skewness]
- Apply clustering algorithm to assign windows to regimes

### 6.2 K-Means Clustering
- Partition observations into K clusters minimizing within-cluster variance
- Algorithm: assign, update centroids, repeat until convergence
- Advantages: simple, fast, interpretable centroids
- Disadvantages: assumes spherical clusters, sensitive to initialization
- Use K=2 to K=4 for financial regime detection

### 6.3 Hierarchical Clustering
- Agglomerative: start with each observation as its own cluster, merge closest pairs
- Dendrogram visualization reveals natural regime structure
- Cut the dendrogram at a chosen level to get K regimes
- Useful for exploratory analysis before committing to a number of regimes

### 6.4 Density-Based Methods (DBSCAN)
- Groups together observations in high-density regions
- Identifies outlier periods as noise (not assigned to any cluster)
- Does not require pre-specifying number of clusters
- May identify rare "crisis" regimes that other methods merge with high-vol

### 6.5 Temporal Constraints
- Standard clustering ignores time ordering; a Monday and a Friday 6 months later
  could be in the same cluster with no temporal contiguity
- Add temporal penalty: assign a cost for switching regimes between consecutive periods
- Or post-process: require minimum regime duration (e.g., 5 days) before switching

---

## 7. Using Regime Detection in Trading

### 7.1 Strategy Selection by Regime
- Maintain a portfolio of sub-strategies:
  - Momentum strategies: activate in trending/low-vol regimes
  - Mean-reversion strategies: activate in sideways/high-vol regimes
  - Defensive strategies: activate in crisis/high-correlation regimes
- Weight sub-strategies by regime probability: w_i = P(regime_i) * base_weight_i

### 7.2 Risk Management by Regime
- Adjust position sizing based on detected regime:
  - Low-vol regime: full position size (1x)
  - High-vol regime: reduce to 0.5x or 0.3x
  - Crisis regime: reduce to minimum or go flat
- Adjust stop-losses: tighter in high-vol, wider in low-vol
- Correlation-based hedging: increase hedges when correlation regime shifts to crisis

### 7.3 Dynamic Parameter Adaptation
- Re-estimate model parameters (e.g., lookback windows, thresholds) per regime
- Example: use 20-day lookback for momentum in trending regime, 5-day in mean-reverting
- Kalman filter approaches: state-space model with regime-dependent parameters

### 7.4 Transition Signals
- The TRANSITION between regimes is itself a signal:
  - Low-vol to high-vol transition: reduce exposure, increase hedges
  - High-vol to low-vol transition: gradually increase exposure
  - Bear to bull transition: initiate long positions
- Monitor filtered regime probabilities for early transition detection
- Use a threshold (e.g., P(new regime) > 0.6) to trigger regime-switch actions

---

## 8. Common Pitfalls

1. **In-sample regime detection**: fitting HMM to full dataset and trading on the labels is lookahead
   - Always use online filtering (data up to time t only) for trading signals
2. **Too many regimes**: K>4 almost certainly overfits; 2-3 is usually sufficient
3. **Ignoring transition costs**: frequent regime switching incurs unnecessary trading costs
   - Add hysteresis: require sustained evidence before switching
4. **Label instability**: HMM regime labels can permute across runs (regime 1 and 2 swap)
   - Sort regimes by volatility or mean to ensure consistent labeling
5. **Non-stationarity of regime dynamics**: transition probabilities themselves may change over decades
6. **Delayed detection**: all methods have detection lag; account for this in backtests
7. **Overfitting regime-dependent strategies**: each regime has less data; models within regimes overfit more easily

---

## 9. Implementation Workflow

1. **Data preparation**: compute features (returns, volatility, correlations) at chosen frequency
2. **Model fitting**: estimate HMM (or chosen model) on training data (2-5 years)
3. **Online filtering**: produce real-time regime probabilities using only past data
4. **Regime labeling**: assign human-interpretable names (sort by vol: low-vol=1, high-vol=2)
5. **Strategy mapping**: define strategy weights and risk parameters per regime
6. **Backtesting**: use filtered (not smoothed) regime probabilities for historical signals
7. **Monitoring**: track regime state, filtered probabilities, and transition frequency in production
8. **Re-estimation**: re-fit model parameters quarterly or after significant market events

---

## 10. Key References

- **Hamilton, J.D. (1989)**. "A New Approach to the Economic Analysis of Nonstationary Time Series and the Business Cycle." *Econometrica*, 57(2), 357-384. -- Foundational regime-switching model.
- **Baum, L.E. et al. (1970)**. "A Maximization Technique Occurring in the Statistical Analysis of Probabilistic Functions of Markov Chains." *Annals of Mathematical Statistics*, 41(1), 164-171. -- Baum-Welch algorithm for HMMs.
- **Adams, R. & MacKay, D. (2007)**. "Bayesian Online Changepoint Detection." arXiv:0710.3742. -- BOCPD for real-time change-point detection.
- **Ang, A. & Bekaert, G. (2002)**. "International Asset Allocation with Regime Shifts." *Review of Financial Studies*, 15(4), 1137-1187. -- Regime switching in portfolio allocation.
- **Bulla, J. & Bulla, I. (2006)**. "Stylized Facts of Financial Time Series and Hidden Semi-Markov Models." *Computational Statistics & Data Analysis*, 51(4), 2192-2209. -- Hidden semi-Markov extensions.
- **Kritzman, M. et al. (2012)**. "Regime Shifts: Implications for Dynamic Strategies." *Financial Analysts Journal*, 68(3), 22-39. -- Practical regime-based allocation.
- **Nystrup, P. et al. (2017)**. "Dynamic Portfolio Optimization Across Hidden Market Regimes." *Quantitative Finance*, 17(12), 1781-1797. -- Regime-aware portfolio construction.
- **Killick, R., Fearnhead, P., & Eckley, I.A. (2012)**. "Optimal Detection of Changepoints with a Linear Computational Cost." *Journal of the American Statistical Association*, 107(500), 1590-1598. -- PELT algorithm.
